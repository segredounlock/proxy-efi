â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  CORREÃ‡ÃƒO DO CÃLCULO DE RECEITA TOTAL - DASHBOARD ADMIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ ARQUIVO CORRIGIDO:
   â€¢ index_DASHBOARD_CORRIGIDO.php

ğŸ”§ PROBLEMA IDENTIFICADO:
   O cÃ¡lculo da "Receita Total" estava usando uma query simples que
   nÃ£o tratava corretamente casos especiais:
   
   Query ANTIGA (com problema):
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SELECT COALESCE(SUM(COALESCE(final_price_cents, price_cents))/100, 0) AS s 
   FROM orders 
   WHERE status IN ('delivered','completed','paid')
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   LIMITAÃ‡Ã•ES da query antiga:
   âœ— NÃ£o valida se os valores sÃ£o maiores que zero
   âœ— Pode somar valores NULL ou zero incorretamente
   âœ— COALESCE aninhado pode causar comportamento inesperado

âœ… SOLUÃ‡ÃƒO IMPLEMENTADA:
   Query CORRIGIDA com validaÃ§Ã£o explÃ­cita:
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SELECT 
     COALESCE(
       SUM(
         CASE 
           WHEN final_price_cents IS NOT NULL AND final_price_cents > 0 
             THEN final_price_cents
           WHEN price_cents IS NOT NULL AND price_cents > 0 
             THEN price_cents
           ELSE 0
         END
       ) / 100, 
       0
     ) AS s 
   FROM orders 
   WHERE status IN ('delivered','completed','paid')
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

   VANTAGENS da query corrigida:
   âœ“ Prioriza final_price_cents quando vÃ¡lido (> 0)
   âœ“ Usa price_cents como fallback quando vÃ¡lido (> 0)
   âœ“ Retorna 0 para registros sem valores vÃ¡lidos
   âœ“ ValidaÃ§Ã£o explÃ­cita de NULL e valores positivos
   âœ“ Comportamento previsÃ­vel e consistente

ğŸ“¦ INSTRUÃ‡Ã•ES DE INSTALAÃ‡ÃƒO:

   1. FaÃ§a backup do seu index.php atual:
      $ cp index.php index.php.backup

   2. Substitua pelo arquivo corrigido:
      $ cp index_DASHBOARD_CORRIGIDO.php index.php

   3. Verifique as permissÃµes:
      $ chmod 644 index.php

   4. Teste o dashboard no navegador
      â€¢ Acesse: /admin/ ou /
      â€¢ Verifique o card "Receita Total"
      â€¢ O valor agora deve estar correto!

ğŸ” COMO VERIFICAR SE FUNCIONOU:

   Execute esta query no seu banco de dados para conferir:
   
   SELECT 
     COUNT(*) as total_pedidos,
     SUM(CASE 
       WHEN final_price_cents IS NOT NULL AND final_price_cents > 0 
         THEN final_price_cents
       WHEN price_cents IS NOT NULL AND price_cents > 0 
         THEN price_cents
       ELSE 0
     END) / 100 AS receita_total
   FROM orders 
   WHERE status IN ('delivered','completed','paid');

   O valor de 'receita_total' deve corresponder ao mostrado no dashboard.

âš ï¸ OBSERVAÃ‡Ã•ES IMPORTANTES:

   â€¢ O arquivo corrigido mantÃ©m 100% da estrutura original
   â€¢ Apenas a query de cÃ¡lculo de receita foi modificada
   â€¢ Todos os outros cards e funcionalidades permanecem iguais
   â€¢ CompatÃ­vel com a estrutura atual do banco de dados

ğŸ’¡ DICA DE DEBUG:

   Se ainda houver diferenÃ§a, verifique:
   
   1. Pedidos com final_price_cents = 0 (devem ser ignorados)
   2. Pedidos com price_cents NULL (devem ser ignorados)
   3. Status dos pedidos (apenas delivered/completed/paid)
   
   Query de debug:
   SELECT 
     id, 
     status, 
     price_cents, 
     final_price_cents,
     CASE 
       WHEN final_price_cents IS NOT NULL AND final_price_cents > 0 
         THEN final_price_cents
       WHEN price_cents IS NOT NULL AND price_cents > 0 
         THEN price_cents
       ELSE 0
     END as valor_usado
   FROM orders 
   WHERE status IN ('delivered','completed','paid')
   ORDER BY created_at DESC 
   LIMIT 20;

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Data da correÃ§Ã£o: 2025-11-25
Sistema: eSIM Admin Dashboard
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
